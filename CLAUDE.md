# 3Panel Interactive Suggestions & Dataset Tracking

This document describes how 3Panel's interactive suggestions and automatic dataset tracking work.

## Table of Contents

1. [Mode Selector Control](#mode-selector-control)
2. [Important Bug Fixes](#important-bug-fixes)
3. [Interactive Suggestions Overview](#interactive-suggestions-overview)
4. [How Interactive Elements Are Created](#how-interactive-elements-are-created)
5. [Dataset Naming Convention](#dataset-naming-convention)
6. [Automatic Dataset Tracking](#automatic-dataset-tracking)
7. [Metadata Flow](#metadata-flow)
8. [Conversation Persistence](#conversation-persistence)
9. [Troubleshooting](#troubleshooting)

---

## Mode Selector Control

**Status:** Fully Implemented

A mode selector control has been added to the center of the toolbar to switch between "Explore" and "Report" modes.

**Modes:**
- **Explore mode**: Users submit prompts â†’ Claude generates R code â†’ Code executes â†’ Output/plots display in split panels (output + code)
- **Report mode**: Single full-height report panel replaces the output and code panels

### Design Specifications

**Background Container:**
- Width: 160px
- Height: 21px
- Background color: #dcdce2
- Border radius: Full rounded (pill shape)
- Position: Centered in toolbar

**Selector Pill:**
- Width: 77px
- Height: 19px
- Background: White
- Drop shadow: `0px 1px 3px rgba(0, 0, 0, 0.1)` (black at 10% opacity, 1px vertical offset, 3px spread)
- Position: Animates between left (1px) for Explore and right (82px) for Report
- Animation: 300ms ease-in-out transition

**Text:**
- Font size: 11px
- Font weight: Medium
- Colors:
  - Selected mode: text-gray-900 (#111827)
  - Unselected mode: text-gray-600 (#4b5563)
- Text changes color based on selection

### Implementation Details

**Location:** `src/App.jsx` lines 1629-1676

**State Management:**
- Uses `viewMode` state: 'explore' or 'report'
- Buttons are functional and update state
- Animation triggers on state change

**Current Behavior:**
- âœ… Buttons are clickable
- âœ… Selector pill animates smoothly between modes
- âœ… Text color changes based on selection
- âœ… Mode switching is fully functional
- âœ… Explore mode shows three-panel layout (chat | output | code)
- âœ… Report mode shows two-panel layout (chat | report)

**Implementation Details:**
1. Conditional rendering based on `viewMode` state ([src/App.jsx:1995-2058](src/App.jsx#L1995-L2058))
2. Split.js adapts to mode:
   - Explore mode: Horizontal split (left-panel | right-column) + Vertical split (output | code)
   - Report mode: Simple horizontal split (left-panel | report-panel)
3. Split.js re-initializes when mode changes ([src/App.jsx:220-271](src/App.jsx#L220-L271))
4. Panel sizes are preserved across mode switches

### Report Mode Content

The report panel shows **dynamic, live-updating content** based on the current state of the analysis:

#### Empty State
- **When**: No dataset has been loaded
- **Display**: "Empty Report" in large, light gray text centered at the top

#### Dataset Loaded
- **Title**: AI-generated by Claude during initial dataset analysis
  - 3-9 words, concise and descriptive
  - Captures the essence of what the dataset contains
  - Generated as part of the JSON response (alongside structure, subject, insights sections)
  - Font: `text-2xl font-semibold text-[#5d5d66]` (matches "Positronic" title on welcome page)
  - Backend extracts it from `reportSections.title` and sends as separate `reportTitle` field
- **Description**: Full text from the "Subject" section of dataset analysis
  - Font: `text-sm text-gray-700` (matches welcome page subtext)
  - Displayed as a paragraph below the title

#### Favorited Outputs
- **When a user favorites an output** (clicks the star icon):
  - Claude generates a concise 2-3 sentence description of the output
  - The output (text, plot, or both) is added to the report
  - Description + output appear in the report panel
- **When a user unfavorites an output**:
  - The output and its description are immediately removed from the report
- **Output rendering**:
  - **Text output**: Rendered as HTML (`dangerouslySetInnerHTML`)
  - **Plots**: Support for multiple formats
    - SVG plots: Rendered inline with `dangerouslySetInnerHTML`
    - PNG images: Rendered with base64 data URLs (`data:image/png;base64,...`)
    - HTML widgets (gt tables, interactive charts): Rendered in iframes
  - **Errors**: Shown in red error boxes (`bg-red-50 border-red-200`)
  - **Styling**: Font size `text-sm` matches welcome page typography
  - All outputs have `rounded-lg shadow-sm` styling

#### Dynamic Updates
- Report state is maintained across mode switches
- Switching between Explore and Report modes shows the current report state
- No "generate report" button needed - report is always current
- **New conversation**: Clicking the "New conversation" toolbar icon clears all report state:
  - `reportTitle` reset to empty string
  - `reportDescription` reset to empty string
  - `favoritedCardIds` cleared (empty Set)
  - `favoritedOutputDescriptions` cleared (empty object)
  - Report reverts to "Empty Report" state

**Future Enhancements:**
- Add export capabilities (PDF, DOCX, etc.)
- Allow manual editing of descriptions
- Support custom report sections
- Add drag-and-drop reordering of favorited outputs

### Backend Implementation

#### Title Generation (server.js)

When a dataset is loaded (CSV or Snowflake), Claude generates the report title as part of the initial analysis:

**JSON Schema includes title field** ([server.js:2340-2346](server.js#L2340-L2346)):
```javascript
{
  "title": "Concise descriptive title for the dataset (3-9 words)",
  "structure": "Text describing exact dimensions and time range if applicable",
  "tidyFormat": "Text describing whether dataset is tidy and what needs to be reshaped",
  "missingData": "Text describing missing data patterns and counts",
  "subject": "Text describing what the dataset is about",
  "insights": "Text describing analysis potential and data completeness"
}
```

**System prompt instructions** ([server.js:2377-2382](server.js#L2377-L2382)):
- First, write the "subject" section describing what the dataset is about
- Then, create a "title" field with a concise, descriptive title (3-9 words)
- The title should capture the essence of what the subject describes
- The title should be professional and suitable for a data analysis report
- DO NOT include the title in the subject text - it's a separate field

**Backend extraction** ([server.js:2690-2693](server.js#L2690-L2693), [server.js:3333-3336](server.js#L3333-L3336)):
```javascript
// Extract title from reportSections and send separately
const reportTitle = reportSections.title || `Dataset: ${filename}`;
// Remove title from reportSections so it doesn't appear in the UI tabs
delete reportSections.title;
```

**Response includes** `reportTitle` field that frontend uses directly.

#### Frontend Report State ([src/App.jsx:61-64](src/App.jsx#L61-L64))

```javascript
// Report state - tracks dynamic report content
const [reportTitle, setReportTitle] = useState('');
const [reportDescription, setReportDescription] = useState('');
const [favoritedOutputDescriptions, setFavoritedOutputDescriptions] = useState({});
```

**On dataset load** ([src/App.jsx:685-697](src/App.jsx#L685-L697), [src/App.jsx:867-879](src/App.jsx#L867-L879)):
- Frontend receives `reportTitle` from backend
- Sets `reportTitle` and `reportDescription` states
- No additional API call needed

**On favorite/unfavorite** ([src/App.jsx:1353-1379](src/App.jsx#L1353-L1379)):
- Favoriting: Generates description via `/api/chat` and adds to report
- Unfavoriting: Removes from `favoritedCardIds` and `favoritedOutputDescriptions`

**On new conversation** ([src/App.jsx:947-951](src/App.jsx#L947-L951)):
- Clears all report state
- Report reverts to empty state

### Code Reference

```javascript
// src/App.jsx line 1631-1676
<div className="absolute left-1/2 transform -translate-x-1/2 flex items-center h-full">
  <div
    className="relative inline-flex items-center rounded-full"
    style={{
      width: '160px',
      height: '21px',
      backgroundColor: '#dcdce2'
    }}
  >
    {/* Animated selector pill */}
    <div
      className="absolute rounded-full transition-all duration-300 ease-in-out"
      style={{
        width: '77px',
        height: '19px',
        backgroundColor: 'white',
        boxShadow: '0px 1px 3px rgba(0, 0, 0, 0.1)',
        left: viewMode === 'explore' ? '1px' : '82px',
        top: '1px'
      }}
    />
    {/* Buttons */}
    ...
  </div>
</div>
```

---

## Important Bug Fixes

### Manual Prompt Bug Fix (Commit: 961cb37)

**Problem:** When users typed manual prompts and clicked the send button, the click event object was being passed to `handleSendMessage()`, resulting in "[object Object]" appearing in the user message bubble instead of the actual prompt text.

**Root Cause:** Line 1960 in `src/App.jsx` had:
```javascript
onClick={handleSendMessage}
```

This passed the synthetic event object as the first parameter.

**Fix:** Changed to:
```javascript
onClick={() => handleSendMessage()}
```

This wraps the handler in an arrow function, preventing the event from being passed.

**Location:** `src/App.jsx` line 1960

**Commit:** 961cb37 "Prompt fixed - no conversation"

### Conversation Storage Removed

**Important:** This codebase does NOT include conversation persistence/localStorage features.

**Why:** The "manual prompt bug fixed" commit (e15c227) added 639 lines including conversation storage features. These were removed because:
1. Only the manual prompt fix was needed
2. Conversation storage was causing view switching issues
3. Simpler single-session approach preferred

**What was removed:**
- Conversation list menu
- localStorage persistence
- Conversation switching
- Auto-save functionality
- Conversation metadata tracking

**Current state:**
- Single conversation session only
- No persistence across page reloads
- Clean, simple user experience

---

---

## Interactive Suggestions Overview

Interactive suggestions allow users to modify values directly in suggestion text before submitting. This provides a powerful way to explore alternatives without retyping prompts.

### Types of Interactive Elements

1. **Categorical Values** - Dropdown lists for swapping country names, species, etc.
2. **Numeric Ranges** - Dual-thumb sliders for year ranges like "1950 to 2020"
3. **Single Numbers** - Single sliders for values like ages or counts

### Example

```
Suggestion: "Create a line plot for Japan from 1950 to 2020"

Interactive:  - "Japan" â†’ hover shows dropdown with [China, India, USA]
              - "1950 to 2020" â†’ hover shows dual-thumb slider (1800-2100)
```

---

## How Interactive Elements Are Created

Interactive suggestions are generated server-side in `server.js` using dataset metadata.

### 1. Categorical Values (`server.js:881-1043`)

**Criteria for making a value interactive:**

```javascript
// Must pass ALL these checks:
1. Value exists in a categorical column (2-250 unique values)
2. Value is NOT a common English word ("and", "to", "for", etc.)
3. Value is at least 4 characters long
4. NOT in a parenthetical list: (Japan, China, India)
5. NOT in a GROUP BY operation: "across countries"
6. NOT in aggregation language: "by country", "for each continent"
```

**Example matches:**
- âœ… "Create a plot for **Japan**" â†’ "Japan" becomes interactive
- âœ… "Compare **China** with other countries" â†’ "China" becomes interactive
- âŒ "Plot across all countries" â†’ No value becomes interactive (aggregation)
- âŒ "Countries (Japan, China, India)" â†’ No values (parenthetical list)

### 2. Numeric Ranges (`server.js:1068-1118`)

**NEW APPROACH (2026-01-07): Claude Explicitly Specifies Column**

Instead of the backend guessing which column a numeric range refers to, **Claude now explicitly declares it** when generating suggestions.

**How It Works:**

1. **Claude generates suggestion** with numeric range JSON:
```json
{
  "text": "Create a line plot showing trends from 1990 to 2020",
  "interactive": {
    "type": "numeric-range",
    "column": "year",           // â† Claude specifies the column!
    "minValue": 1990,
    "maxValue": 2020
  }
}
```

2. **Backend validates and processes:**
   - Checks if column exists in metadata
   - Validates column is numeric type
   - Finds range text in suggestion for positioning
   - Creates dual-thumb slider with correct bounds

3. **Result:** Reliable, accurate range sliders

**System Prompt Instructions ([server.js:2324-2340](server.js#L2324-L2340)):**
```
OPTION 2 - NUMERIC RANGE:
* Include a numeric range in your suggestion (e.g., "from 1990 to 2020")
* âš ï¸ CRITICAL: You MUST explicitly specify which COLUMN the range refers to
* Provide interactive object with these fields:
  - "type": "numeric-range"
  - "column": the EXACT column name from the schema
  - "minValue": the minimum value in your suggestion
  - "maxValue": the maximum value in your suggestion
```

**Advantages over old text-parsing approach:**
- âœ… No ambiguity when multiple columns could match
- âœ… Claude knows context (e.g., "1990 to 2020" refers to `year`, not `life_expectancy`)
- âœ… Works with any column name (not just "year")
- âœ… Reliable across all datasets

**Fallback behavior:**
- If Claude doesn't specify `column`, backend falls back to old text-parsing logic
- Ensures backwards compatibility

**Example matches:**
- âœ… "Plot from **1990 to 2020**" with `column: "year"` â†’ Year slider (1800-2100)
- âœ… "Ages **25 to 65**" with `column: "age"` â†’ Age slider (0-100)
- âœ… "Life expectancy between **50 and 80**" with `column: "life_expectancy"` â†’ LE slider (1-95)

### 3. Single Numeric Values (`server.js:1124-1196`)

Less commonly used. Requires confident column match via:
- Column name appears near the value
- Value falls within column's bounds
- Context suggests filtering/selection (not aggregation)

---

## Dataset Naming Convention

### The `_tidy` Suffix Rule

**When converting data to tidy format, always append `_tidy` to the dataset name:**

```r
# âœ… CORRECT
lex_tidy <- lex %>%
  pivot_longer(cols = starts_with("X"),
               names_to = "year",
               values_to = "life_expectancy")

# âŒ WRONG - overwrites original
lex <- lex %>% pivot_longer(...)

# âŒ WRONG - doesn't use _tidy suffix
lex_long <- lex %>% pivot_longer(...)
```

### Why This Matters

1. **Preserves original data** - You can always reference the wide format
2. **Automatic tracking** - System detects `_tidy` datasets and switches to them
3. **Predictable naming** - Always know which dataset is active
4. **Better suggestions** - Tidy datasets have the right columns for analysis

### Implementation

**System Prompt (`server.js:679-703`):**
```
===== CRITICAL NAMING CONVENTION FOR TIDY TRANSFORMATIONS =====

When generating R code that converts data to tidy format:

REQUIRED BEHAVIOR:
1. ALWAYS create a NEW dataset with "_tidy" appended to the original name
2. DO NOT overwrite the original dataset

CORRECT EXAMPLES:
âœ“ lex_tidy <- lex %>% pivot_longer(...)
âœ“ population_tidy <- population %>% pivot_longer(...)
```

---

## Automatic Dataset Tracking

### How It Works

When you transform data to tidy format, the system automatically:

1. **Detects** the `_tidy` suffix during R code execution
2. **Refreshes** metadata for the new dataset (columns, types, values)
3. **Switches** the active dataset to the tidy version
4. **Uses** the tidy dataset for future code generation and suggestions

### Step-by-Step Flow

```
1. Load Data
   User: Load lex.csv
   System: Creates dataset "lex" with columns [geo, name, X1800, X1801, ..., X2100]
   Active Dataset: "lex"

2. Tidy Transformation
   User: "Convert to tidy format"
   Claude: Generates code â†’ lex_tidy <- lex %>% pivot_longer(...)
   System: Executes code

3. Auto-Detection (server.js:1802)
   Code: const isTidyDataset = detectedDataset.endsWith('_tidy');
   Result: isTidyDataset = true

4. Metadata Refresh (server.js:1603-1817)
   System: Runs str(lex_tidy), extracts columns, values, min/max
   Result: Metadata shows [geo, name, year, life_expectancy]

5. Auto-Switch (src/App.jsx:1296-1319)
   Frontend: Receives shouldBecomeActive: true
   Code: activeDataset = shouldBecomeActive ? 'lex_tidy' : prev.activeDataset
   Active Dataset: "lex_tidy" âœ“

6. Future Code Generation (server.js:120-130)
   System Prompt: "ğŸ¯ ACTIVE DATASET: lex_tidy"
   Claude: Uses "lex_tidy" in all generated R code

7. Interactive Suggestions
   System: Has "year" column in metadata (min: 1800, max: 2100)
   Result: Year ranges become interactive! âœ“
```

### Key Code Locations

**Backend Detection:**
```javascript
// server.js:1802 - Detect tidy datasets
const isTidyDataset = detectedDataset.endsWith('_tidy');

result.updatedMetadata = {
  datasetName: detectedDataset,
  columnMetadata: columnMetadata,
  shouldBecomeActive: isTidyDataset,  // Auto-switch flag
  hash: JSON.stringify({...})
};
```

**Frontend Auto-Switch:**
```javascript
// src/App.jsx:1300-1303 - Auto-switch active dataset
setDatasetRegistry(prev => ({
  ...prev,
  activeDataset: shouldBecomeActive ? datasetName : prev.activeDataset,
  datasets: {...}
}));
```

**Active Dataset in Prompts:**
```javascript
// server.js:120-130 - Include in system prompt
schemaInfo = `
CURRENT DATASET SCHEMA:
ğŸ¯ ACTIVE DATASET: ${activeDatasetName}
Numeric columns: year, life_expectancy
Categorical columns: name, geo

âš ï¸ CRITICAL: When writing R code, you MUST use "${activeDatasetName}".
`;
```

---

## Metadata Flow

### From R Execution to Interactive Suggestions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. R Code Execution                                     â”‚
â”‚    User runs: lex_tidy <- lex %>% pivot_longer(...)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Dataset Detection (server.js:1286-1301)             â”‚
â”‚    Pattern match: /^(\w+)\s*<-/                        â”‚
â”‚    Result: detectedDataset = "lex_tidy"                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Metadata Refresh (server.js:1635-1743)              â”‚
â”‚    Runs R code:                                         â”‚
â”‚      str(lex_tidy)                                      â”‚
â”‚      summary(lex_tidy)                                  â”‚
â”‚    Extracts:                                            â”‚
â”‚      - Column names: [geo, name, year, life_expectancy]â”‚
â”‚      - Categorical values: name â†’ [China, India, ...]  â”‚
â”‚      - Numeric ranges: year â†’ min:1800, max:2100       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Frontend Registry Update (src/App.jsx:1300-1312)    â”‚
â”‚    datasetRegistry.activeDataset = "lex_tidy"          â”‚
â”‚    datasetRegistry.datasets["lex_tidy"] = {            â”‚
â”‚      columnMetadata: [{name:"year",min:1800,max:2100}] â”‚
â”‚    }                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Next API Call (src/App.jsx:1153-1160)               â”‚
â”‚    sendMessageToClaude(                                 â”‚
â”‚      cleanColumnMetadata,  // From lex_tidy            â”‚
â”‚      activeDatasetName: "lex_tidy"                     â”‚
â”‚    )                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Claude Response with Suggestions                     â”‚
â”‚    Claude sees: ACTIVE DATASET: lex_tidy               â”‚
â”‚                 Numeric columns: year (1800-2100)       â”‚
â”‚    Generates suggestion:                                â”‚
â”‚      "Plot from 1950 to 2020 for Japan"                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Interactive Elements Added (server.js:881-1196)     â”‚
â”‚    Categorical: "Japan" â†’ matches "name" column         â”‚
â”‚    Range: "1950 to 2020" â†’ matches "year" column       â”‚
â”‚                                                         â”‚
â”‚    Result: {                                            â”‚
â”‚      text: "Plot from 1950 to 2020 for Japan",         â”‚
â”‚      interactive: {                                     â”‚
â”‚        value: "Japan",                                  â”‚
â”‚        options: ["China", "India", "Japan", "USA"]     â”‚
â”‚      }                                                  â”‚
â”‚    }                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Render Interactive UI (InteractiveSuggestion.jsx)   â”‚
â”‚    User hovers "Japan" â†’ dropdown appears               â”‚
â”‚    User hovers "1950 to 2020" â†’ dual slider appears    â”‚
â”‚    User modifies values â†’ text updates                  â”‚
â”‚    User clicks â†’ submits modified suggestion            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Troubleshooting

### Issue: Year ranges not interactive

**Problem:** Suggestions show year ranges but they're not interactive.

**Cause:** The active dataset doesn't have a `year` column in metadata.

**Check:**
1. Open browser console
2. Look for: `[/api/chat] Has "year" column: false`
3. Check active dataset: `[/api/chat] activeDatasetName: data`

**Solution:**
- Ensure tidy transformation creates `lex_tidy` (not overwrites `lex`)
- Re-run the tidy transformation code
- Watch for: `[EXECUTE] Auto-switching active dataset to 'lex_tidy'`

### Issue: Countries not interactive

**Problem:** Country names in suggestions aren't interactive.

**Causes:**
1. ~~Low cardinality filter blocking them~~ (FIXED)
2. Suggestion text uses aggregation language
3. Values in parenthetical lists

**Check server logs:**
```bash
tail -100 /tmp/claude/.../server.log | grep -i "skipping"
```

**Common blocks:**
- `Skipping "China" - in parenthetical list`
- `Skipping "USA" - part of GROUP BY operation`
- `Skipping "India" - strong aggregation language`

**Solution:**
- Rephrase suggestions to be more specific:
  - âŒ "Compare life expectancy across all countries"
  - âœ… "Create a line plot for Japan to visualize trends"

### Issue: Wrong dataset used in generated code

**Problem:** Claude generates code using `lex` instead of `lex_tidy`.

**Cause:** Active dataset not being sent to API.

**Check:**
1. Browser console: Look for API payload
2. Server logs: `[/api/chat] activeDatasetName: lex_tidy`

**Solution:**
- Refresh the page (frontend state may be stale)
- Re-run tidy transformation if needed
- Check `datasetRegistry.activeDataset` in React DevTools

### Issue: Metadata overwritten by intermediate results

**Problem:** Created `milestone_70 <- lex_tidy %>% filter(...)` and lost `lex_tidy` metadata.

**Status:** FIXED - System now only refreshes metadata for detected dataset, not active dataset.

**Behavior now:**
- Creating `milestone_70` will NOT overwrite `lex_tidy` metadata
- Only creating a new `*_tidy` dataset will switch active dataset
- Intermediate results are tracked but don't become active

---

## Implementation Checklist

When modifying the interactive suggestions system:

### Adding new interactive element types:

- [ ] Update `server.js` suggestion processing (lines 881-1196)
- [ ] Add pattern matching for the new type
- [ ] Add column metadata matching logic
- [ ] Update `InteractiveSuggestion.jsx` to render the UI
- [ ] Add CSS styles in `index.css`
- [ ] Test with real dataset

### Modifying semantic filters:

- [ ] Update filters in `server.js:934-1008`
- [ ] Add logging for debugging: `console.log('[/api/chat] Skipping...')`
- [ ] Test with various suggestion phrasings
- [ ] Document the new filter behavior in this file

### Changing dataset tracking:

- [ ] Update detection logic in `server.js:1283-1301`
- [ ] Update auto-switch logic in `src/App.jsx:1300-1319`
- [ ] Update system prompt in `server.js` to match new convention
- [ ] Test full workflow: load â†’ transform â†’ generate code
- [ ] Update this documentation

---

## Conversation Persistence

**Status:** Fully Implemented (2026-01-12)

3Panel now automatically saves and restores your conversation state across page reloads until you explicitly click "New Conversation".

### What Gets Persisted

**Conversation Data:**
- All messages (user and assistant)
- All code cards with outputs (plots, tables, text)
- Selected code card

**Report Data:**
- Report title and description
- Favorited card IDs
- Favorited output descriptions

**Dataset State:**
- Dataset registry (all loaded datasets with metadata)
- Active dataset name
- Column metadata for each dataset

**UI State:**
- View mode (Explore or Report)
- Expanded suggestions

### Storage Mechanism

**localStorage Key:** `3panel_conversation_state`

**Storage Structure:**
```javascript
{
  version: "1.0",
  timestamp: 1704067200000,
  state: {
    messages: [...],
    codeCards: [...],
    reportTitle: "...",
    reportDescription: "...",
    favoritedCardIds: [...],
    favoritedOutputDescriptions: {...},
    datasetRegistry: {...},
    viewMode: "explore",
    selectedCardId: "card-123",
    expandedSuggestions: [...]
  }
}
```

### How It Works

#### 1. Auto-Save on State Changes

Saves are **debounced** (2 seconds) to avoid excessive writes:

**Triggers:**
- Message sent
- Code executed
- Card favorited/unfavorited
- Dataset loaded
- View mode changed
- Selected card changed

**Optimization:**
- Uses hash-based change detection to skip redundant saves
- Only saves if state actually changed

#### 2. Immediate Save on Page Unload

When you close the tab or refresh the page:
- `beforeunload` event triggers immediate save
- No debounce, ensures all changes are captured

#### 3. Auto-Restore on Page Load

When you open 3Panel:
- Checks localStorage for saved state
- If found, restores all state silently
- No prompt or confirmation needed

#### 4. Clear on "New Conversation"

Clicking "New Conversation" button:
- Clears all in-memory state
- Deletes localStorage entry
- Clears R workspace (backend)
- Next reload starts fresh

### Large Data Handling

**Problem:** Base64 PNG images can be 100-500KB each, quickly exceeding localStorage limits (5-10MB).

**Solution:** Smart size optimization

1. **Check size before saving:**
   - If serialized state > 4MB, strip PNG data from plots
   - Keep SVG data (much smaller, ~10-30KB)
   - Plots still render correctly via SVG

2. **If still too large:**
   - Show `StorageWarningModal` with options:
     - "Clear conversation" - start fresh
     - "Continue without saving" - work without persistence

3. **Console logging:**
   - `[PERSIST] Preparing to save state (2.3 MB)` - normal save
   - `[PERSIST] Size exceeds 4.00 MB, optimizing...` - PNG stripping activated
   - `[PERSIST] Optimized size: 1.8 MB` - after optimization

### R Workspace Persistence

**Status:** Fully Implemented (2026-01-12)

**The Solution:**

R workspace now persists automatically across server restarts. When you stop the server (Ctrl+C) or the server crashes:

1. **On Shutdown:** R workspace is saved to `.r-workspace.RData` (permanent storage)
2. **On Startup:** R workspace is restored from `.r-workspace.RData` if it exists
3. **Result:** All datasets, variables, and transformations are preserved

**How It Works:**

```
Server Shutdown (Ctrl+C) â†’
  â”œâ”€ Workspace saved from temp location
  â”œâ”€ Copied to .r-workspace.RData (permanent)
  â””â”€ Server exits

Server Startup â†’
  â”œâ”€ Check if .r-workspace.RData exists
  â”œâ”€ If yes: Copy to temp location
  â”œâ”€ R loads workspace on next execution
  â””â”€ All datasets available immediately
```

**"New Conversation" Clears Both:**
- Deletes temp workspace: `tmpdir()/3panel-r-execution/workspace.RData`
- Deletes persistent workspace: `.r-workspace.RData`
- Next startup is a fresh session

**Console Output:**

On startup with previous session:
```
ğŸš€ Proxy server running on http://localhost:3001
ğŸ“¡ Ready to proxy requests to Anthropic API
ğŸ”§ R code execution endpoint available

ğŸ“‚ Restoring R workspace from previous session...
âœ“ R workspace restored
```

On startup without previous session:
```
ğŸš€ Proxy server running on http://localhost:3001
ğŸ“¡ Ready to proxy requests to Anthropic API
ğŸ”§ R code execution endpoint available

No previous workspace found (fresh start)
```

On shutdown (Ctrl+C):
```
ğŸ›‘ Received SIGINT, shutting down gracefully...
ğŸ’¾ Saving R workspace...
âœ“ R workspace saved to persistent storage
```

**Benefits:**

- âœ… Datasets persist across server restarts
- âœ… Tidy transformations preserved (`obesity_by_income`, etc.)
- âœ… No need to reload CSVs or reconnect to Snowflake
- âœ… Seamless experience - just reload the page
- âœ… **DatasetRestorationBanner no longer needed** (datasets are actually there!)

**Implementation Details:**

- **Persistent storage:** `.r-workspace.RData` in project root (added to `.gitignore`)
- **Temp storage:** `tmpdir()/3panel-r-execution/workspace.RData` (used during execution)
- **Shutdown handlers:** SIGINT, SIGTERM (graceful shutdown)
- **Startup restoration:** Automatic on `app.listen()`
- **File operations:** Uses R's `file.copy()` via `Rscript -e`

### UI Components

#### StorageWarningModal

**Purpose:** Shown when localStorage quota is exceeded

**Location:** [src/components/StorageWarningModal.jsx](src/components/StorageWarningModal.jsx)

**Triggered by:** `QuotaExceededError` during save attempt

**Options:**
- "Clear Conversation" - Clears all state and localStorage
- "Continue Without Saving" - Dismisses modal, app continues working without persistence

#### DatasetRestorationBanner

**Purpose:** Warns that datasets need manual reload after page restore

**Status:** âš ï¸ Mostly unnecessary with R workspace persistence (but kept as safety net)

**Location:** [src/components/DatasetRestorationBanner.jsx](src/components/DatasetRestorationBanner.jsx)

**Shown when:** Conversation restored with datasets in registry

**Why it still shows:**
- Banner appears whenever datasets exist in localStorage
- Doesn't check if R workspace actually has them
- With workspace persistence, datasets ARE there, so banner is a false alarm
- Users can safely dismiss it immediately

**Future improvement:**
- Add backend check to see if datasets exist in R before showing banner
- OR remove banner entirely since workspace persistence makes it unnecessary

**Features:**
- Lists base datasets (CSV/Snowflake)
- Lists tidy transformations (need base dataset first)
- "Dismiss" button to hide banner
- Sticky position at top of chat panel

### Implementation Details

#### Core Functions (App.jsx)

**saveConversationState()** ([App.jsx:110-154](src/App.jsx#L110-L154))
- Builds state object with Set â†’ Array serialization
- Checks size, strips PNGs if needed
- Saves to localStorage
- Handles QuotaExceededError

**loadConversationState()** ([App.jsx:204-258](src/App.jsx#L204-L258))
- Loads from localStorage on mount
- Validates structure and contents
- Converts Arrays â†’ Sets
- Restores all state with safe defaults
- Shows dataset warning if datasets exist

**clearConversationState()** ([App.jsx:263-270](src/App.jsx#L263-L270))
- Removes from localStorage
- Called by "New Conversation" button

**debouncedSave()** ([App.jsx:167-198](src/App.jsx#L167-L198))
- 2 second debounce
- Hash-based change detection
- Skips save if state unchanged

#### Persistence Hooks (App.jsx:539-580)

**Debounced save on state changes:**
```javascript
useEffect(() => {
  debouncedSave();
}, [messages, codeCards, reportTitle, reportDescription, ...]);
```

**Immediate save on beforeunload:**
```javascript
useEffect(() => {
  const handleBeforeUnload = () => {
    saveConversationStateImmediate();
  };
  window.addEventListener('beforeunload', handleBeforeUnload);
  return () => window.removeEventListener('beforeunload', handleBeforeUnload);
}, [...]);
```

#### Utility Functions (utils/persistence.js)

**File:** [src/utils/persistence.js](src/utils/persistence.js)

Key utilities:
- `getStorageSize(data)` - Calculate serialized size in bytes
- `formatBytes(bytes)` - Human-readable size strings
- `optimizeCodeCards(codeCards)` - Strip PNG data to reduce size
- `hashObject(obj)` - Generate hash for change detection
- `serializeState(state)` - Convert Sets â†’ Arrays
- `deserializeState(state)` - Convert Arrays â†’ Sets
- `validateState(state)` - Validate structure before restore

### Configuration

**Constants** (persistence.js:8-14):
```javascript
PERSISTENCE_CONFIG = {
  STORAGE_KEY: '3panel_conversation_state',
  VERSION: '1.0',
  SAVE_DEBOUNCE_MS: 2000,           // 2 seconds
  MAX_SIZE_BYTES: 4 * 1024 * 1024,  // 4MB
  STORAGE_LIMIT_ESTIMATE: 5 * 1024 * 1024  // 5MB
}
```

### What Does NOT Get Persisted

**Transient UI State:**
- `isLoading`, `isSubmitAnimating`, `isRecording`
- Modal visibility states (`showApiKeyModal`, `showSnowflakeModal`)
- `inputValue` (half-typed message)

**Already Persisted Separately:**
- `apiKey` - stored in 'anthropic_api_key'
- `autoFormatTabular` - stored in 'auto_format_tabular'

**Backend State:**
- R workspace (live process, doesn't persist)
- Server session data

**Panel Sizes:**
- Split.js panel dimensions (intentional - avoids view switching issues)

### Avoiding Historical "View Switching Issues"

Previous implementation (removed in earlier commits) caused view switching problems. Prevention strategies:

1. **Don't persist panel sizes** - Let Split.js initialize naturally on each load
2. **Debounced saves** - Prevent race conditions during rapid state changes
3. **Hash-based change detection** - Prevent infinite save loops
4. **No side effects in persistence functions** - Just save/restore data, don't trigger actions

### Console Logging

Enable detailed logging by checking browser console:

**Normal operation:**
```
[PERSIST] Preparing to save state (1.2 MB)
[PERSIST] âœ“ State saved successfully
[PERSIST] Loading state from 1/12/2026, 3:45:00 PM
[PERSIST] âœ“ State loaded successfully
```

**Size optimization:**
```
[PERSIST] Preparing to save state (5.8 MB)
[PERSIST] Size exceeds 4.00 MB, optimizing...
[PERSIST] Stripped PNG data to reduce size
[PERSIST] Optimized size: 2.1 MB
[PERSIST] âœ“ State saved successfully
```

**Errors:**
```
[PERSIST] Storage quota exceeded
[PERSIST] Error loading state: SyntaxError: Unexpected token
[PERSIST] Invalid state format, clearing
```

### Troubleshooting

#### Issue: Conversation not persisting

**Check:**
1. Browser console for `[PERSIST]` log messages
2. DevTools â†’ Application â†’ Local Storage â†’ verify `3panel_conversation_state` exists
3. Check for QuotaExceededError in console

**Common causes:**
- localStorage disabled in browser
- Private/incognito mode (some browsers limit storage)
- Storage quota exceeded (see warning modal)

#### Issue: Datasets don't work after reload

**Expected behavior** - This is normal!

R workspace doesn't persist across page reloads. You must:
1. Look for yellow `DatasetRestorationBanner` at top of chat
2. Re-upload CSV files or reconnect to Snowflake
3. For tidy datasets, re-run transformation code

**Why we don't auto-reload:**
- CSV files may have moved
- Snowflake credentials may have changed
- Simpler and more reliable to let user control it

#### Issue: "Storage quota exceeded" modal keeps appearing

**Causes:**
- Very long conversation (100+ messages)
- Many large plots (10+ PNG images)
- Browser has low localStorage limit (some mobile browsers)

**Solutions:**
1. Click "Clear Conversation" to start fresh
2. Generate fewer plots (code-only analysis)
3. Use "Continue Without Saving" if you don't need persistence

#### Issue: State loads but some data is missing

**Check:**
- Console for validation warnings
- May indicate corrupted data or old version

**Fix:**
- Click "New Conversation" to clear
- Will start fresh next time

### Testing

**Manual test checklist:**

1. âœ… **Basic save/restore:**
   - Load CSV, send messages, execute code
   - Reload page â†’ verify conversation restored

2. âœ… **Large data:**
   - Generate 10+ plots
   - Reload page â†’ verify plots display (SVG)
   - Check console for PNG stripping warning

3. âœ… **Dataset restoration (deprecated with R workspace persistence):**
   - Load CSV, transform to tidy
   - Reload page â†’ verify banner appears (false alarm)
   - Dismiss banner â†’ datasets work without reload

3b. âœ… **R workspace persistence:**
   - Load CSV, create variables, transform to tidy
   - Stop server (Ctrl+C) â†’ verify "Saving workspace" message
   - Restart server â†’ verify "Restoring workspace" message
   - Run code using datasets â†’ verify they exist without reload

4. âœ… **New conversation:**
   - Have active conversation
   - Click "New Conversation"
   - Reload page â†’ verify fresh start

5. âœ… **Mode switching:**
   - Work in Explore mode
   - Switch to Report mode
   - Reload page â†’ verify Report mode persists

### Future Enhancements

Potential improvements (out of scope for v1):

1. **Multiple conversation slots** - Save/load named conversations
2. **Cloud sync** - Sync across devices (requires backend)
3. **Export/import** - Download conversation as JSON file
4. **Automatic dataset re-loading** - Store file paths and reload automatically
5. **Compression** - Use LZ-string for better storage efficiency
6. **IndexedDB migration** - Larger storage limit (25MB+)
7. **Selective persistence** - Let user choose what to save

---

## File Reference

### Key Files

| File | Purpose | Lines |
|------|---------|-------|
| `server.js` | Backend logic for suggestions, dataset tracking & R workspace persistence | 79-3880 |
| `src/App.jsx` | Frontend dataset registry, code execution & conversation persistence | 52-2575 |
| `src/components/InteractiveSuggestion.jsx` | Interactive UI component | 1-416 |
| `src/components/StorageWarningModal.jsx` | Storage quota exceeded modal | 1-68 |
| `src/components/DatasetRestorationBanner.jsx` | Dataset reload warning banner (deprecated) | 1-67 |
| `src/utils/claudeApi.js` | API communication with active dataset | 20-35 |
| `src/utils/persistence.js` | Conversation persistence utilities | 1-171 |
| `src/index.css` | Styles for interactive elements | 240-420 |
| `.r-workspace.RData` | Persistent R workspace storage (gitignored) | N/A |

### Important Functions

**Backend:**
- `app.post('/api/chat')` - Main API endpoint with suggestion generation
- `app.post('/api/execute-r')` - R code execution with metadata refresh
- `app.post('/api/clear-workspace')` - Clear R workspace (temp + persistent)
- `saveWorkspaceOnShutdown()` - Save R workspace to persistent storage on SIGINT/SIGTERM
- `loadWorkspaceOnStartup()` - Restore R workspace from persistent storage on server start
- `executeRWorkspaceOperation()` - Helper to execute R code for workspace operations

**Frontend:**
- `handleSendMessage()` - Sends messages with active dataset
- `executeRCode()` - Executes R code and updates registry
- `InteractiveSuggestion` - Renders interactive suggestion UI
- `saveConversationState()` - Saves state to localStorage with size optimization
- `loadConversationState()` - Restores state from localStorage on mount
- `clearConversationState()` - Clears persisted state

---

## Future Enhancements

Potential improvements to consider:

1. **Smart dataset switching** - Detect when user references old dataset and offer to switch
2. **Multi-dataset support** - Allow multiple datasets to be active simultaneously
3. **Dataset visualization** - Show dataset tree/graph in UI
4. **Undo/redo** - Track dataset transformations and allow reverting
5. **Interactive validation** - Warn when suggestion values don't match current dataset
6. **Custom interactive types** - Allow users to define their own interactive elements
7. **Suggestion templates** - Pre-built suggestion patterns for common analyses

---

Last updated: 2026-01-12
